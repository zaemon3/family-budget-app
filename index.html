<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家計簿アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .nav-tab.active {
            background: white;
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            padding: 25px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            opacity: 0.1;
            font-size: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .income-card {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #2d5016;
        }
        
        .expense-card {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #8b0000;
        }
        
        .balance-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2c3e50;
        }
        
        .card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .card .amount {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .card .trend {
            font-size: 24px;
            float: right;
            margin-top: -40px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            margin-bottom: 20px;
            color: #495057;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
        }
        
        .transactions-list {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .transaction-item {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: between;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .transaction-item:hover {
            background: #f8f9fa;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-info {
            flex: 1;
        }
        
        .transaction-description {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .transaction-meta {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .transaction-amount {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .transaction-amount.income {
            color: #28a745;
        }
        
        .transaction-amount.expense {
            color: #dc3545;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 15px;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .chart-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #495057;
            text-align: center;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .export-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tab {
                padding: 15px 10px;
                font-size: 14px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-row, .filter-row {
                grid-template-columns: 1fr;
            }
            
            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>家計簿アプリ</h1>
            <p>毎日の収支を簡単に管理しましょう</p>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('dashboard')">ダッシュボード</div>
            <div class="nav-tab" onclick="switchTab('monthly')">月別データ</div>
            <div class="nav-tab" onclick="switchTab('yearly')">年別データ</div>
            <div class="nav-tab" onclick="switchTab('analysis')">支出分析</div>
            <div class="nav-tab" onclick="switchTab('backup')">共有・バックアップ</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-cards">
                <div class="card income-card">
                    <h3>総収入</h3>
                    <div class="amount" id="totalIncome">¥0</div>
                    <div class="trend">📈</div>
                </div>
                <div class="card expense-card">
                    <h3>総支出</h3>
                    <div class="amount" id="totalExpense">¥0</div>
                    <div class="trend">📉</div>
                </div>
                <div class="card balance-card">
                    <h3>残高</h3>
                    <div class="amount" id="balance">¥0</div>
                    <div class="trend">💰</div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>新しい取引を追加</h3>
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="description">説明</label>
                            <input type="text" id="description" required placeholder="例：食費、給料など">
                        </div>
                        <div class="form-group">
                            <label for="amount">金額</label>
                            <input type="number" id="amount" required placeholder="金額を入力">
                        </div>
                        <div class="form-group">
                            <label for="type">種類</label>
                            <select id="type" required>
                                <option value="">選択してください</option>
                                <option value="income">収入</option>
                                <option value="expense">支出</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category">カテゴリ <span id="typeIndicator" style="font-size: 14px; margin-left: 10px;"></span></label>
                            <select id="category" required onchange="updateCategoryType()">
                                <option value="">選択してください</option>
                                <optgroup label="収入">
                                    <option value="給料">給料</option>
                                    <option value="副収入">副収入</option>
                                    <option value="ボーナス">ボーナス</option>
                                </optgroup>
                                <optgroup label="支出">
                                    <option value="食費">食費</option>
                                    <option value="交通費">交通費</option>
                                    <option value="娯楽">娯楽</option>
                                    <option value="光熱費">光熱費</option>
                                    <option value="家賃">家賃</option>
                                    <option value="通信費">通信費</option>
                                    <option value="医療費">医療費</option>
                                    <option value="日用品">日用品</option>
                                    <option value="その他">その他</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date">日付</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">追加</button>
                </form>
            </div>
            
            <div class="transactions-list">
                <h3 style="padding: 20px; margin: 0; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">今日の取引</h3>
                <div id="transactionsList"></div>
            </div>
        </div>
        
        <div id="monthly" class="tab-content">
            <div class="filter-section">
                <h3>月別データ表示</h3>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="yearSelectMonthly">年:</label>
                        <select id="yearSelectMonthly" onchange="updateSelectedMonth()">
                            <option value="2025">2025年</option>
                            <option value="2024">2024年</option>
                            <option value="2023">2023年</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="monthSelectMonthly">月:</label>
                        <select id="monthSelectMonthly" onchange="updateSelectedMonth()">
                            <option value="01">1月</option>
                            <option value="02">2月</option>
                            <option value="03">3月</option>
                            <option value="04">4月</option>
                            <option value="05">5月</option>
                            <option value="06">6月</option>
                            <option value="07">7月</option>
                            <option value="08">8月</option>
                            <option value="09">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">月別収支グラフ</div>
                <canvas id="monthlyChart" width="400" height="200"></canvas>
            </div>
            
            <div id="monthlyData"></div>
        </div>
        
        <div id="yearly" class="tab-content">
            <div class="filter-section">
                <h3>年別フィルター</h3>
                <div class="filter-row">
                    <div class="form-group">
                        <label for="yearFilter">年を選択</label>
                        <select id="yearFilter"></select>
                    </div>
                    <button class="btn btn-primary" onclick="filterByYear()">表示</button>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">年別収支グラフ</div>
                <canvas id="yearlyChart" width="400" height="200"></canvas>
            </div>
            
            <div id="yearlyData"></div>
        </div>
        
        <div id="analysis" class="tab-content">
            <div class="chart-container">
                <div class="chart-title">支出カテゴリ別分析</div>
                <canvas id="categoryChart" width="400" height="400"></canvas>
            </div>
            
            <div id="categoryAnalysis"></div>
            
            <div class="export-section">
                <h3>データの管理</h3>
                <p>データをバックアップしたり、他の形式で保存できます。</p>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="exportToJSON()">JSONで保存</button>
                    <button class="btn btn-success" onclick="exportToCSV()">CSVで保存</button>
                    <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="importData()">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">データを復元</button>
                    <button class="btn btn-danger" onclick="clearAllData()">全データ削除</button>
                </div>
            </div>
        </div>
        
        <div id="backup" class="tab-content">
            <div class="form-section">
                <h2 class="chart-title">🔗 データの共有・バックアップ</h2>
                
                <!-- データエクスポート -->
                <div style="margin-bottom: 30px;">
                    <h3>💾 データのバックアップ</h3>
                    
                    <!-- 期間選択 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e9ecef;">
                        <h4 style="margin-bottom: 15px; color: #495057;">保存期間を選択</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="exportPeriod" value="all" checked onchange="setExportPeriod(this.value)">
                                <span style="font-size: 14px;">全期間</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="exportPeriod" value="current-month" onchange="setExportPeriod(this.value)">
                                <span style="font-size: 14px;">今月</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="exportPeriod" value="current-year" onchange="setExportPeriod(this.value)">
                                <span style="font-size: 14px;">今年</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="exportPeriod" value="custom" onchange="setExportPeriod(this.value)">
                                <span style="font-size: 14px;">期間指定</span>
                            </label>
                        </div>
                        
                        <!-- カスタム期間設定 -->
                        <div id="customPeriodSettings" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #495057;">開始日</label>
                                    <input type="date" id="exportStartDate" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 5px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #495057;">終了日</label>
                                    <input type="date" id="exportEndDate" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 5px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 選択された期間の情報表示 -->
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 5px;">
                            <p style="font-size: 14px; color: #1976d2; margin: 0;">
                                📊 対象件数: <strong id="exportTargetCount">0件</strong>
                                <span id="exportPeriodInfo"></span>
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #bbdefb;">
                        <p style="font-size: 14px; color: #1976d2; margin: 0;">
                            家計簿データをファイルとしてダウンロードできます。このファイルを使って他のデバイスでデータを復元したり、バックアップとして保存できます。
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="exportFilteredJSON()">JSONで保存</button>
                        <button class="btn btn-success" onclick="exportFilteredCSV()">CSVで保存</button>
                    </div>
                    <div style="font-size: 12px; color: #6c757d;">
                        <p><strong>JSON:</strong> 完全なデータ保存（推奨）</p>
                        <p><strong>CSV:</strong> Excel・スプレッドシートで開ける形式</p>
                    </div>
                </div>

                <!-- データインポート -->
                <div style="margin-bottom: 30px;">
                    <h3>📂 データの復元</h3>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                        <p style="font-size: 14px; color: #856404; margin: 0; margin-bottom: 8px;">
                            ⚠️ 注意: データを復元すると、現在のデータは上書きされます。必要に応じて事前にバックアップを取ってください。
                        </p>
                        <p style="font-size: 14px; color: #856404; margin: 0;">
                            📄 対応形式: JSON、CSV（Excel等で編集可能）
                        </p>
                    </div>
                    <button class="btn btn-success" onclick="document.getElementById('importFile').click()">ファイルを選択して復元</button>
                </div>

                <!-- URL共有 -->
                <div style="margin-bottom: 30px;">
                    <h3>🔗 URLで共有</h3>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                        <p style="font-size: 14px; color: #155724; margin: 0;">
                            データを含むURLを生成して、家族や他のデバイスと共有できます。URLにアクセスするだけでデータが読み込まれます。
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="generateShareUrl()">共有URLを生成</button>
                        <button class="btn btn-primary" id="copyUrlBtn" onclick="copyShareUrl()" style="display: none;">URLをコピー</button>
                    </div>
                    
                    <div id="shareUrlContainer" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <p style="font-size: 14px; color: #6c757d; margin-bottom: 8px;">生成された共有URL:</p>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="shareUrlInput" readonly style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 5px; background: white; font-size: 12px;">
                        </div>
                    </div>
                    
                    <div id="copyMessage" style="display: none; margin-top: 10px; padding: 8px; background: #d4edda; color: #155724; border-radius: 5px; font-size: 14px;">
                        ✅ URLをクリップボードにコピーしました！
                    </div>
                </div>

                <!-- データクリア -->
                <div style="margin-bottom: 30px;">
                    <h3>🗑️ データの削除</h3>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
                        <p style="font-size: 14px; color: #721c24; margin: 0;">
                            ⚠️ 警告: この操作を実行すると、すべての取引データが完全に削除されます。この操作は元に戻すことができません。
                        </p>
                    </div>
                    <button class="btn btn-danger" onclick="clearAllData()">すべてのデータを削除</button>
                </div>

                <!-- 使い方ガイド -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3>📖 使い方ガイド</h3>
                    <div style="font-size: 14px; color: #6c757d; line-height: 1.6;">
                        <div style="margin-bottom: 15px;">
                            <h4 style="font-weight: 600; color: #495057; margin-bottom: 5px;">💾 自動保存機能</h4>
                            <p style="margin: 0;">データは入力と同時に自動的にブラウザに保存されます。ブラウザを閉じても、再度開くときにデータが復元されます。</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h4 style="font-weight: 600; color: #495057; margin-bottom: 5px;">🏠 家族間でのデータ共有</h4>
                            <p style="margin: 0;">1. 「共有URLを生成」でURLを作成<br>2. 「URLをコピー」でクリップボードにコピー<br>3. 家族にURLを送信（LINE、メールなど）<br>4. 受け取った人がURLにアクセス</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h4 style="font-weight: 600; color: #495057; margin-bottom: 5px;">📊 CSVファイルでの活用</h4>
                            <p style="margin: 0;">1. 「CSVで保存」でデータをダウンロード<br>2. Excel・Googleスプレッドシートで開いて編集<br>3. 編集後のCSVファイルを「ファイルを選択して復元」でインポート<br>4. グラフ作成や詳細分析に活用</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h4 style="font-weight: 600; color: #495057; margin-bottom: 5px;">📱 他のデバイスでの利用</h4>
                            <p style="margin: 0;">1. 「JSONで保存」でバックアップファイルを保存<br>2. ファイルを他のデバイスに転送（メール添付、クラウドストレージなど）<br>3. 他のデバイスで「ファイルを選択して復元」</p>
                        </div>
                        <div>
                            <h4 style="font-weight: 600; color: #495057; margin-bottom: 5px;">💾 定期的なバックアップ</h4>
                            <p style="margin: 0;">月末などに定期的に「JSONで保存」を実行して、重要なデータを安全に保管することをお勧めします。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        
        // 初期化
        document.getElementById('date').valueAsDate = new Date();
        
        // 月別セレクトボックスの初期化
        function initializeMonthSelectors() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            
            // 年選択の初期化
            const yearSelect = document.getElementById('yearSelectMonthly');
            if (yearSelect) {
                yearSelect.value = currentYear;
            }
            
            // 月選択の初期化
            const monthSelect = document.getElementById('monthSelectMonthly');
            if (monthSelect) {
                monthSelect.value = currentMonth;
            }
            
            // selectedMonthを更新
            selectedMonth = `${currentYear}-${currentMonth}`;
        }
        
        function updateSelectedMonth() {
            const yearSelect = document.getElementById('yearSelectMonthly');
            const monthSelect = document.getElementById('monthSelectMonthly');
            
            if (yearSelect && monthSelect) {
                selectedMonth = `${yearSelect.value}-${monthSelect.value}`;
                
                // 月別データを更新
                if (document.getElementById('monthly').classList.contains('active')) {
                    updateMonthlyDisplay();
                }
            }
        }
        
        function updateMonthlyDisplay() {
            const currentMonthData = getMonthlyData(selectedMonth);
            
            // 月別サマリーを更新
            const monthlyIncome = currentMonthData
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyExpense = currentMonthData
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            // サマリーカードを更新（月別タブ内の要素を更新）
            const monthlyCards = document.querySelector('#monthly .dashboard-cards');
            if (monthlyCards) {
                monthlyCards.innerHTML = `
                    <div class="card income-card">
                        <h3>月間収入</h3>
                        <div class="amount">¥${monthlyIncome.toLocaleString()}</div>
                        <div class="trend">📈</div>
                    </div>
                    <div class="card expense-card">
                        <h3>月間支出</h3>
                        <div class="amount">¥${monthlyExpense.toLocaleString()}</div>
                        <div class="trend">📉</div>
                    </div>
                    <div class="card balance-card">
                        <h3>月間収支</h3>
                        <div class="amount">¥${(monthlyIncome - monthlyExpense).toLocaleString()}</div>
                        <div class="trend">💰</div>
                    </div>
                `;
            }
            
            // 取引一覧を更新
            updateMonthlyTransactionsList(currentMonthData);
        }
        
        function updateMonthlyTransactionsList(monthData) {
            const listContainer = document.querySelector('#monthly .transactions-list div:last-child');
            if (!listContainer) return;
            
            if (monthData.length === 0) {
                listContainer.innerHTML = '<div class="no-data">この月は取引がありません</div>';
                return;
            }
            
            listContainer.innerHTML = monthData
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(transaction => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-description">${transaction.description}</div>
                            <div class="transaction-meta">${transaction.category} • ${new Date(transaction.date).toLocaleDateString('ja-JP')}</div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}¥${transaction.amount.toLocaleString()}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">削除</button>
                    </div>
                `).join('');
        }
        
        initializeApp();
        initializeMonthSelectors();
        
        function initializeApp() {
            updateDashboard();
            updateTransactionsList();
            setupYearFilter();
            renderCharts();
        }
        
        function switchTab(tabName) {
            // タブの表示切り替え
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // タブが切り替わったときにチャートを再描画
            setTimeout(() => {
                renderCharts();
            }, 100);
        }
        
        function addTransaction(event) {
            event.preventDefault();
            
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            
            const transaction = {
                id: Date.now(),
                description,
                amount,
                type,
                category,
                date,
                timestamp: new Date().toISOString()
            };
            
            transactions.push(transaction);
            saveTransactions();
            updateDashboard();
            updateTransactionsList();
            renderCharts();
            
            // フォームをリセット
            document.getElementById('transactionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
        }
        
        function deleteTransaction(id) {
            if (confirm('この取引を削除しますか？')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDashboard();
                updateTransactionsList();
                renderCharts();
            }
        }
        
        function updateDashboard() {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = totalIncome - totalExpense;
            
            document.getElementById('totalIncome').textContent = `¥${totalIncome.toLocaleString()}`;
            document.getElementById('totalExpense').textContent = `¥${totalExpense.toLocaleString()}`;
            document.getElementById('balance').textContent = `¥${balance.toLocaleString()}`;
        }
        
        let currentFilter = 'all';
        
        function setFilter(filterType) {
            currentFilter = filterType;
            
            // ボタンのスタイルを更新
            const allBtn = document.getElementById('filterAll');
            const incomeBtn = document.getElementById('filterIncome');
            const expenseBtn = document.getElementById('filterExpense');
            
            // すべてのボタンをリセット
            [allBtn, incomeBtn, expenseBtn].forEach(btn => {
                if (btn) {
                    btn.className = 'px-4 py-2 rounded-lg font-medium transition-colors bg-white text-gray-700 hover:bg-gray-100';
                }
            });
            
            // アクティブなボタンを設定
            if (filterType === 'all' && allBtn) {
                allBtn.className = 'px-4 py-2 rounded-lg font-medium transition-colors bg-blue-500 text-white';
            } else if (filterType === 'income' && incomeBtn) {
                incomeBtn.className = 'px-4 py-2 rounded-lg font-medium transition-colors bg-green-500 text-white';
            } else if (filterType === 'expense' && expenseBtn) {
                expenseBtn.className = 'px-4 py-2 rounded-lg font-medium transition-colors bg-red-500 text-white';
            }
            
            // 取引リストを更新
            updateFilteredTransactionsList();
        }
        
        // 当日の取引のみを取得（ダッシュボード用）
        function getTodaysTransactions() {
            // 今日の日付を日本時間で取得
            const today = new Date();
            const todayString = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
            
            return transactions.filter(t => t.date === todayString);
        }
        
        function updateTransactionsList() {
            updateFilteredTransactionsList();
        }sList');
            let todaysTransactions = getTodaysTransactions();
            
            // フィルターを適用
            if (currentFilter === 'income') {
                todaysTransactions = todaysTransactions.filter(t => t.type === 'income');
            } else if (currentFilter === 'expense') {
                todaysTransactions = todaysTransactions.filter(t => t.type === 'expense');
            }
            
            if (todaysTransactions.length === 0) {
                let message = '今日はまだ取引がありません';
                if (currentFilter === 'income') {
                    message = '今日はまだ収入の取引がありません';
                } else if (currentFilter === 'expense') {
                    message = '今日はまだ支出の取引がありません';
                }
                listElement.innerHTML = `<div class="no-data">${message}</div>`;
                return;
            }
            
            const sortedTransactions = [...todaysTransactions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            listElement.innerHTML = sortedTransactions
                .map(transaction => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-description">${transaction.description}</div>
                            <div class="transaction-meta">${transaction.category} • ${new Date(transaction.date).toLocaleDateString('ja-JP')}</div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}¥${transaction.amount.toLocaleString()}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">削除</button>
                    </div>
                `).join('');
        }
        
        function setupYearFilter() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            const years = new Set();
            
            transactions.forEach(t => {
                years.add(new Date(t.date).getFullYear());
            });
            
            if (years.size === 0) {
                years.add(currentYear);
            }
            
            yearSelect.innerHTML = Array.from(years)
                .sort((a, b) => b - a)
                .map(year => `<option value="${year}">${year}年</option>`)
                .join('');
        }
        
        function filterByMonth() {
            const monthFilter = document.getElementById('monthFilter').value;
            if (!monthFilter) return;
            
            const [year, month] = monthFilter.split('-');
            const filteredTransactions = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getFullYear() == year && (tDate.getMonth() + 1) == month;
            });
            
            displayMonthlyData(filteredTransactions, monthFilter);
        }
        
        function displayMonthlyData(data, month) {
            const container = document.getElementById('monthlyData');
            const totalIncome = data.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = data.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            container.innerHTML = `
                <div class="dashboard-cards">
                    <div class="card income-card">
                        <h3>${new Date(month + '-01').toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' })}の収入</h3>
                        <div class="amount">¥${totalIncome.toLocaleString()}</div>
                    </div>
                    <div class="card expense-card">
                        <h3>${new Date(month + '-01').toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' })}の支出</h3>
                        <div class="amount">¥${totalExpense.toLocaleString()}</div>
                    </div>
                    <div class="card balance-card">
                        <h3>月末残高</h3>
                        <div class="amount">¥${(totalIncome - totalExpense).toLocaleString()}</div>
                    </div>
                </div>
                <div class="transactions-list">
                    <h3 style="padding: 20px; margin: 0; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">取引一覧</h3>
                    <div>${data.length === 0 ? '<div class="no-data">該当する取引がありません</div>' : 
                        data.sort((a, b) => new Date(b.date) - new Date(a.date))
                            .map(t => `
                                <div class="transaction-item">
                                    <div class="transaction-info">
                                        <div class="transaction-description">${t.description}</div>
                                        <div class="transaction-meta">${t.category} • ${new Date(t.date).toLocaleDateString('ja-JP')}</div>
                                    </div>
                                    <div class="transaction-amount ${t.type}">
                                        ${t.type === 'income' ? '+' : '-'}¥${t.amount.toLocaleString()}
                                    </div>
                                </div>
                            `).join('')
                    }</div>
                </div>
            `;
        }
        
        function filterByYear() {
            const year = document.getElementById('yearFilter').value;
            if (!year) return;
            
            const filteredTransactions = transactions.filter(t => {
                return new Date(t.date).getFullYear() == year;
            });
            
            displayYearlyData(filteredTransactions, year);
        }
        
        function displayYearlyData(data, year) {
            const container = document.getElementById('yearlyData');
            const totalIncome = data.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = data.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            container.innerHTML = `
                <div class="dashboard-cards">
                    <div class="card income-card">
                        <h3>${year}年の収入</h3>
                        <div class="amount">¥${totalIncome.toLocaleString()}</div>
                    </div>
                    <div class="card expense-card">
                        <h3>${year}年の支出</h3>
                        <div class="amount">¥${totalExpense.toLocaleString()}</div>
                    </div>
                    <div class="card balance-card">
                        <h3>年末残高</h3>
                        <div class="amount">¥${(totalIncome - totalExpense).toLocaleString()}</div>
                    </div>
                </div>
            `;
        }
        
        function renderCharts() {
            renderCategoryChart();
            renderMonthlyChart();
            renderYearlyChart();
        }
        
        function renderCategoryChart() {
            const canvas = document.getElementById('categoryChart');
            const ctx = canvas.getContext('2d');
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const expenses = transactions.filter(t => t.type === 'expense');
            if (expenses.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('支出データがありません', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const categoryTotals = {};
            expenses.forEach(t => {
                categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
            });
            
            const categories = Object.keys(categoryTotals);
            const totals = Object.values(categoryTotals);
            const total = totals.reduce((sum, val) => sum + val, 0);
            
            // 円グラフを描画
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 50;
            
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];
            
            let currentAngle = -Math.PI / 2;
            
            categories.forEach((category, index) => {
                const sliceAngle = (totals[index] / total) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                
                // ラベルを描画
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
                const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
                
                ctx.fillStyle = '#333';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(category, labelX, labelY);
                ctx.fillText(`¥${totals[index].toLocaleString()}`, labelX, labelY + 15);
                
                currentAngle += sliceAngle;
            });
            
            // 分析データを表示
            const analysisContainer = document.getElementById('categoryAnalysis');
            analysisContainer.innerHTML = `
                <div class="dashboard-cards">
                    ${categories.map((category, index) => `
                        <div class="card expense-card" style="background: ${colors[index % colors.length]}20; border-left: 5px solid ${colors[index % colors.length]};">
                            <h3>${category}</h3>
                            <div class="amount">¥${categoryTotals[category].toLocaleString()}</div>
                            <div class="transaction-meta">${((categoryTotals[category] / total) * 100).toFixed(1)}%</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderMonthlyChart() {
            const canvas = document.getElementById('monthlyChart');
            const ctx = canvas.getContext('2d');
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (transactions.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('データがありません', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // 月別データを集計
            const monthlyData = {};
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expense: 0 };
                }
                
                if (t.type === 'income') {
                    monthlyData[monthKey].income += t.amount;
                } else {
                    monthlyData[monthKey].expense += t.amount;
                }
            });
            
            const months = Object.keys(monthlyData).sort();
            const maxValue = Math.max(...months.map(month => 
                Math.max(monthlyData[month].income, monthlyData[month].expense)
            ));
            
            if (months.length === 0) return;
            
            // グラフの設定
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const barWidth = chartWidth / months.length / 2 - 10;
            
            // 軸を描画
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // Y軸
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.stroke();
            
            // X軸
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // データを描画
            months.forEach((month, index) => {
                const x = padding + (index * chartWidth / months.length);
                const incomeHeight = (monthlyData[month].income / maxValue) * chartHeight;
                const expenseHeight = (monthlyData[month].expense / maxValue) * chartHeight;
                
                // 収入バー
                ctx.fillStyle = '#28a745';
                ctx.fillRect(x, canvas.height - padding - incomeHeight, barWidth, incomeHeight);
                
                // 支出バー
                ctx.fillStyle = '#dc3545';
                ctx.fillRect(x + barWidth + 5, canvas.height - padding - expenseHeight, barWidth, expenseHeight);
                
                // 月ラベル
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(month, x + barWidth, canvas.height - padding + 20);
            });
            
            // 凡例
            ctx.fillStyle = '#28a745';
            ctx.fillRect(canvas.width - 150, 20, 15, 15);
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('収入', canvas.width - 130, 32);
            
            ctx.fillStyle = '#dc3545';
            ctx.fillRect(canvas.width - 150, 40, 15, 15);
            ctx.fillStyle = '#333';
            ctx.fillText('支出', canvas.width - 130, 52);
        }
        
        function renderYearlyChart() {
            const canvas = document.getElementById('yearlyChart');
            const ctx = canvas.getContext('2d');
            
            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (transactions.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('データがありません', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // 年別データを集計
            const yearlyData = {};
            transactions.forEach(t => {
                const year = new Date(t.date).getFullYear();
                
                if (!yearlyData[year]) {
                    yearlyData[year] = { income: 0, expense: 0 };
                }
                
                if (t.type === 'income') {
                    yearlyData[year].income += t.amount;
                } else {
                    yearlyData[year].expense += t.amount;
                }
            });
            
            const years = Object.keys(yearlyData).sort();
            const maxValue = Math.max(...years.map(year => 
                Math.max(yearlyData[year].income, yearlyData[year].expense)
            ));
            
            if (years.length === 0) return;
            
            // グラフの設定
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const barWidth = chartWidth / years.length / 2 - 10;
            
            // 軸を描画
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // Y軸
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.stroke();
            
            // X軸
            ctx.beginPath();
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // データを描画
            years.forEach((year, index) => {
                const x = padding + (index * chartWidth / years.length);
                const incomeHeight = (yearlyData[year].income / maxValue) * chartHeight;
                const expenseHeight = (yearlyData[year].expense / maxValue) * chartHeight;
                
                // 収入バー
                ctx.fillStyle = '#28a745';
                ctx.fillRect(x, canvas.height - padding - incomeHeight, barWidth, incomeHeight);
                
                // 支出バー
                ctx.fillStyle = '#dc3545';
                ctx.fillRect(x + barWidth + 5, canvas.height - padding - expenseHeight, barWidth, expenseHeight);
                
                // 年ラベル
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(year + '年', x + barWidth, canvas.height - padding + 20);
            });
            
            // 凡例
            ctx.fillStyle = '#28a745';
            ctx.fillRect(canvas.width - 150, 20, 15, 15);
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('収入', canvas.width - 130, 32);
            
            ctx.fillStyle = '#dc3545';
            ctx.fillRect(canvas.width - 150, 40, 15, 15);
            ctx.fillStyle = '#333';
            ctx.fillText('支出', canvas.width - 130, 52);
        }
        
        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }
        
        function exportToJSON() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `家計簿データ_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function exportToCSV() {
            const csvContent = [
                ['日付', '説明', 'カテゴリ', '種類', '金額'],
                ...transactions.map(t => [
                    t.date,
                    t.description,
                    t.category,
                    t.type === 'income' ? '収入' : '支出',
                    t.amount
                ])
            ].map(row => row.join(',')).join('\n');
            
            const BOM = '\uFEFF';
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(BOM + csvContent);
            
            const exportFileDefaultName = `家計簿データ_${new Date().toISOString().split('T')[0]}.csv`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.json')) {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('現在のデータを上書きしますか？')) {
                            transactions = importedData;
                            saveTransactions();
                            initializeApp();
                            alert('データをインポートしました。');
                        }
                    } else if (file.name.endsWith('.csv')) {
                        const csvData = e.target.result;
                        const lines = csvData.split('\n');
                        const importedTransactions = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line) {
                                const [date, description, category, type, amount] = line.split(',');
                                importedTransactions.push({
                                    id: Date.now() + i,
                                    date: date,
                                    description: description,
                                    category: category,
                                    type: type === '収入' ? 'income' : 'expense',
                                    amount: parseFloat(amount),
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                        
                        if (confirm('現在のデータを上書きしますか？')) {
                            transactions = importedTransactions;
                            saveTransactions();
                            initializeApp();
                            alert('CSVデータをインポートしました。');
                        }
                    }
                } catch (error) {
                    alert('ファイルの形式が正しくありません。');
                }
            };
            reader.readAsText(file);
        }
        
        function clearAllData() {
            if (confirm('本当にすべてのデータを削除しますか？この操作は元に戻せません。')) {
                if (confirm('最後の確認です。すべてのデータが削除されます。続行しますか？')) {
                    transactions = [];
                    saveTransactions();
                    initializeApp();
                    alert('すべてのデータを削除しました。');
                }
            }
        }
        
        // フォームのイベントリスナーを設定
        document.getElementById('transactionForm').addEventListener('submit', addTransaction);
        
        // 月フィルターの初期値を設定
        const currentDate = new Date();
        const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('monthFilter').value = currentMonth;
        
        // エクスポート機能の変数
        let exportPeriod = 'all';
        
        function setExportPeriod(period) {
            exportPeriod = period;
            const customSettings = document.getElementById('customPeriodSettings');
            
            if (period === 'custom') {
                customSettings.style.display = 'block';
            } else {
                customSettings.style.display = 'none';
            }
            
            updateExportInfo();
        }
        
        function updateExportInfo() {
            const filteredTransactions = getFilteredTransactionsForExport();
            const countElement = document.getElementById('exportTargetCount');
            const infoElement = document.getElementById('exportPeriodInfo');
            
            if (countElement) {
                countElement.textContent = `${filteredTransactions.length}件`;
            }
            
            if (infoElement) {
                const today = new Date();
                let info = '';
                
                switch (exportPeriod) {
                    case 'current-month':
                        info = ` (${today.getFullYear()}年${today.getMonth() + 1}月)`;
                        break;
                    case 'current-year':
                        info = ` (${today.getFullYear()}年)`;
                        break;
                    case 'custom':
                        const startDate = document.getElementById('exportStartDate')?.value;
                        const endDate = document.getElementById('exportEndDate')?.value;
                        if (startDate && endDate) {
                            info = ` (${startDate} ～ ${endDate})`;
                        }
                        break;
                }
                
                infoElement.textContent = info;
            }
        }
        
        function getFilteredTransactionsForExport() {
            if (exportPeriod === 'all') {
                return transactions;
            }
            
            const today = new Date();
            let startDate, endDate;
            
            switch (exportPeriod) {
                case 'current-month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'current-year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                case 'custom':
                    const startDateStr = document.getElementById('exportStartDate')?.value;
                    const endDateStr = document.getElementById('exportEndDate')?.value;
                    if (!startDateStr || !endDateStr) return [];
                    startDate = new Date(startDateStr);
                    endDate = new Date(endDateStr);
                    break;
                default:
                    return transactions;
            }
            
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            return transactions.filter(transaction => {
                return transaction.date >= startDateStr && transaction.date <= endDateStr;
            });
        }
        
        function exportFilteredJSON() {
            const filteredTransactions = getFilteredTransactionsForExport();
            const dataToExport = {
                transactions: filteredTransactions,
                exportDate: new Date().toISOString(),
                period: exportPeriod,
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            // ファイル名に期間情報を含める
            const today = new Date();
            let filename = '家計簿データ';
            if (exportPeriod === 'current-month') {
                filename += `_${today.getFullYear()}年${today.getMonth() + 1}月`;
            } else if (exportPeriod === 'current-year') {
                filename += `_${today.getFullYear()}年`;
            } else if (exportPeriod === 'custom') {
                const startDate = document.getElementById('exportStartDate')?.value;
                const endDate = document.getElementById('exportEndDate')?.value;
                if (startDate && endDate) {
                    filename += `_${startDate}_${endDate}`;
                }
            } else {
                filename += `_全期間`;
            }
            filename += `_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', filename);
            linkElement.click();
        }
        
        function exportFilteredCSV() {
            const filteredTransactions = getFilteredTransactionsForExport();
            const csvContent = [
                ['日付', '説明', 'カテゴリ', '種類', '金額'],
                ...filteredTransactions.map(t => [
                    t.date,
                    t.description,
                    t.category,
                    t.type === 'income' ? '収入' : '支出',
                    t.amount
                ])
            ].map(row => row.join(',')).join('\n');
            
            const BOM = '\uFEFF';
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(BOM + csvContent);
            
            // ファイル名に期間情報を含める
            const today = new Date();
            let filename = '家計簿データ';
            if (exportPeriod === 'current-month') {
                filename += `_${today.getFullYear()}年${today.getMonth() + 1}月`;
            } else if (exportPeriod === 'current-year') {
                filename += `_${today.getFullYear()}年`;
            } else if (exportPeriod === 'custom') {
                const startDate = document.getElementById('exportStartDate')?.value;
                const endDate = document.getElementById('exportEndDate')?.value;
                if (startDate && endDate) {
                    filename += `_${startDate}_${endDate}`;
                }
            } else {
                filename += `_全期間`;
            }
            filename += `_${new Date().toISOString().split('T')[0]}.csv`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', filename);
            linkElement.click();
        }
        
        function generateShareUrl() {
            const encodedData = btoa(JSON.stringify(transactions));
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?data=${encodedData}`;
            
            document.getElementById('shareUrlInput').value = shareUrl;
            document.getElementById('shareUrlContainer').style.display = 'block';
            document.getElementById('copyUrlBtn').style.display = 'inline-block';
        }
        
        function copyShareUrl() {
            const shareUrlInput = document.getElementById('shareUrlInput');
            shareUrlInput.select();
            shareUrlInput.setSelectionRange(0, 99999); // モバイル対応
            
            try {
                navigator.clipboard.writeText(shareUrlInput.value).then(function() {
                    showCopyMessage();
                }).catch(function() {
                    // フォールバック
                    document.execCommand('copy');
                    showCopyMessage();
                });
            } catch (err) {
                // さらなるフォールバック
                document.execCommand('copy');
                showCopyMessage();
            }
        }
        
        function showCopyMessage() {
            const copyMessage = document.getElementById('copyMessage');
            copyMessage.style.display = 'block';
            setTimeout(() => {
                copyMessage.style.display = 'none';
            }, 2000);
        }
        
        // URLパラメータからデータを読み込み（共有URL機能）
        function loadSharedData() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            if (sharedData) {
                try {
                    const decodedData = JSON.parse(atob(sharedData));
                    transactions = decodedData;
                    saveTransactions();
                    initializeApp();
                    alert('共有データを読み込みました！');
                } catch (error) {
                    console.error('共有データの読み込みに失敗しました:', error);
                }
            }
        }
        
        // ページ読み込み時に共有データをチェック
        loadSharedData();
        
        // エクスポート情報を定期的に更新
        setInterval(updateExportInfo, 1000);
    </script>
</body>
</html>
